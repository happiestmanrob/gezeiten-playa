<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gezeiten · Playa del Inglés</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue:#2563eb;--green:#16a34a;--red:#dc2626;--muted:#6b7280;
      --bg:#e8f5ff;--white:#fff;--shadow:0 8px 24px rgba(0,0,0,.05);--radius:20px;
    }
    body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:#111;}
    .wrap{max-width:750px;margin:20px auto;padding:0 16px;}
    .card{background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px 20px;}
    .title{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800;font-size:32px;}
    .logo{width:36px;}
    .date{text-align:center;color:var(--muted);font-weight:600;margin:2px 0 8px;}
    .trendIcon{text-align:center;font-size:32px;margin-top:4px;}
    .trend{text-align:center;font-weight:700;margin:2px 0;color:var(--green);}
    .trend.down{color:var(--red);}
    .sub{text-align:center;color:var(--muted);margin-top:2px;font-size:14px;}
    .controls{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin:14px 0 10px;}
    .btn{padding:8px 14px;border:1px solid #ccc;border-radius:10px;background:#fff;cursor:pointer;font-weight:600;}
    .btn.active{background:var(--blue);color:#fff;border-color:var(--blue);}
    select{padding:8px 12px;border-radius:10px;border:1px solid #ccc;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{text-align:center;padding:10px 8px;}
    th{color:var(--muted);font-weight:700;}
    tr+tr td{border-top:1px solid #eee;}
    .type-high{color:var(--green);font-weight:700;}
    .type-low{color:var(--red);font-weight:700;}
    .footer{text-align:center;margin-top:12px;color:var(--muted);font-size:13px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <img class="logo" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f30a.svg" alt="">
        <div>Gezeiten · Playa del Inglés</div>
      </div>

      <div id="humanDate" class="date">–</div>
      <div id="trendIcon" class="trendIcon">⬆️</div>
      <div id="trendText" class="trend">Das Wasser steigt</div>
      <div id="nextInfo" class="sub">(nächstes Hochwasser um –:–)</div>

      <div class="controls">
        <button class="btn" id="btnToday">Heute</button>
        <button class="btn" id="btnTomorrow">Morgen</button>
        <button class="btn" id="btnDayAfter">Übermorgen</button>
        <select id="dateSelect"></select>
      </div>

      <table>
        <thead>
          <tr><th>Zeit</th><th>Typ</th><th>Höhe (m)</th></tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="3">Lade …</td></tr></tbody>
      </table>

      <div class="footer" id="foot">Quelle: tide-forecast.com</div>
    </div>
  </div>

<script>
const DATA_URL = "./data/latest.json";
const fmtDE = new Intl.DateTimeFormat("de-DE",{dateStyle:"full",timeZone:"Atlantic/Canary"});
const tbody=document.getElementById("tbody"),sel=document.getElementById("dateSelect");
const hd=document.getElementById("humanDate"),trendIcon=document.getElementById("trendIcon");
const trendText=document.getElementById("trendText"),nextInfo=document.getElementById("nextInfo"),foot=document.getElementById("foot");
const btns=[btnToday,btnTomorrow,btnDayAfter].map(id=>document.getElementById(id));

let DAYS=[],UPDATED="",tz="WET";
const nowCanary=()=>new Date().toLocaleString("sv-SE",{timeZone:"Atlantic/Canary"}).split(" ")[0];
const nowHM=()=>new Date().toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit",hour12:false,timeZone:"Atlantic/Canary"});
function render(iso){
  const d=DAYS.find(x=>x.date===iso);if(!d){tbody.innerHTML="<tr><td colspan=3>Keine Daten.</td></tr>";return;}
  hd.textContent=fmtDE.format(new Date(iso+"T12:00:00Z"));
  tbody.innerHTML=d.entries.map(e=>{
    const c=e.type==="Hochwasser"?"type-high":"type-low";
    return `<tr><td>${e.time}</td><td class="${c}">${e.type}</td><td>${e.height_m.toFixed(2)}</td></tr>`;
  }).join("");
  const now=nowCanary();
  let rising=true,next=d.entries[0];
  if(iso===now){const hm=nowHM();next=d.entries.find(e=>e.time>=hm)||next;rising=next.type==="Hochwasser";}
  trendIcon.textContent=rising?"⬆️":"⬇️";
  trendText.textContent=rising?"Das Wasser steigt":"Das Wasser fällt";
  trendText.classList.toggle("down",!rising);
  nextInfo.textContent=`(nächstes ${next.type} um ${next.time})`;
  foot.textContent=`Quelle: tide-forecast.com · Aktualisiert: ${UPDATED} ${tz}`;
}
function setActive(b){btns.forEach(x=>x.classList.remove("active"));if(b)b.classList.add("active");}
async function init(){
  const r=await fetch(DATA_URL,{cache:"no-store"});const j=await r.json();
  DAYS=j.days;UPDATED=j.updatedAt;tz=j.timezone;
  sel.innerHTML=DAYS.map(d=>`<option value="${d.date}">${fmtDE.format(new Date(d.date+"T12:00:00Z"))}</option>`).join("");
  const today=nowCanary(),idx=DAYS.findIndex(d=>d.date===today);
  const goto=i=>{if(i<0)return;setActive(null);sel.value=DAYS[i].date;render(DAYS[i].date);};
  btns[0].onclick=()=>{setActive(btns[0]);render(DAYS[idx]?.date||DAYS[0].date);};
  btns[1].onclick=()=>{setActive(btns[1]);render(DAYS[idx+1]?.date||DAYS[1].date);};
  btns[2].onclick=()=>{setActive(btns[2]);render(DAYS[idx+2]?.date||DAYS[2].date);};
  sel.onchange=()=>{setActive(null);render(sel.value);};
  render(idx>=0?DAYS[idx].date:DAYS[0].date);setActive(btns[0]);
}
init().catch(e=>tbody.innerHTML=`<tr><td colspan=3>Fehler: ${e}</td></tr>`);
</script>
</body>
</html>
