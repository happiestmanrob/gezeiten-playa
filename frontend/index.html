<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gezeiten Â· Playa del InglÃ©s</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#e8f0ff; --bg2:#dff7ef;
      --card:#ffffff; --muted:#667085;
      --hi:#16a34a20; --lo:#ef444420;
      --pill:#f1f5f9; --ring:#e2e8f0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto;
      background:radial-gradient(1200px 600px at 20% 10%,var(--bg1),transparent) no-repeat,
                 radial-gradient(1200px 600px at 80% 90%,var(--bg2),transparent) no-repeat,
                 #f6fbff;
      color:#0f172a;
      display:flex; align-items:flex-start; justify-content:center;
    }
    .wrap{width:100%; max-width:980px; padding:48px 16px}
    .card{
      background:var(--card); border:1px solid var(--ring);
      border-radius:18px; padding:28px 28px 8px; box-shadow:0 20px 40px rgba(2,6,23,.06);
    }
    h1{margin:0 0 6px; font-size:26px}
    .meta{color:var(--muted); font-size:14px; margin-bottom:6px}
    .date{font-weight:700; text-align:center; margin:16px 0 6px}
    .trend{
      text-align:center; color:#0f172a; font-weight:600; margin:0 0 14px;
    }
    table{width:100%; border-collapse:collapse; margin-top:6px}
    th,td{padding:14px 12px; border-bottom:1px solid var(--ring); text-align:left}
    th{font-size:14px; color:var(--muted); font-weight:600}
    .badge{
      display:inline-block; padding:4px 10px; border-radius:9999px; font-weight:600; font-size:12px;
    }
    .high{background:var(--hi); color:#166534}
    .low{background:var(--lo); color:#9a3412}
    .src{font-size:12px; color:var(--muted); text-align:center; margin:18px 0 10px}
    .jsonlink{float:right; font-size:13px}
    @media (max-width:640px){ th,td{padding:10px 8px} .wrap{padding:32px 12px} }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <h1>Gezeiten Â· Playa del InglÃ©s</h1>
          <div class="meta" id="meta">Playa del InglÃ©s Â· Zeiten in Atlantic/Canary</div>
        </div>
        <a class="jsonlink" href="latest.json" target="_blank">ðŸ“„ JSON</a>
      </div>

      <div class="date" id="dateLabel">â€“</div>
      <div class="trend" id="trend"> </div>

      <table>
        <thead>
          <tr>
            <th style="width:22%">Zeit</th>
            <th style="width:28%">Typ</th>
            <th style="width:20%">HÃ¶he (m)</th>
            <th style="width:auto"></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" style="text-align:center;color:#64748b;">Lade Datenâ€¦</td></tr>
        </tbody>
      </table>

      <div class="src" id="source"> </div>
    </section>
  </main>

  <script>
    const TZ = "Atlantic/Canary";

    function tLocal(iso) {
      try {
        return new Date(iso).toLocaleTimeString("de-DE", { timeZone: TZ, hour: "2-digit", minute: "2-digit" });
      } catch { return "â€“"; }
    }

    function nowTz() {
      return new Date(new Date().toLocaleString("en-US", { timeZone: TZ }));
    }

    function computeTrend(tides) {
      if (!tides || !tides.length) return { text: "â€“", next: null };
      const now = nowTz();
      // nÃ¤chstes Ereignis
      const upcoming = tides
        .map(t => ({ ...t, when: new Date(t.iso) }))
        .filter(t => t.when >= now)
        .sort((a,b) => a.when - b.when)[0] || null;

      if (!upcoming) return { text: "â€“", next: null };
      const rising = upcoming.type === "High";
      const when = tLocal(upcoming.iso);
      return {
        text: rising
          ? `Das Wasser steigt (nÃ¤chstes Hochwasser um ${when})`
          : `Das Wasser fÃ¤llt (nÃ¤chstes Niedrigwasser um ${when})`,
        next: upcoming
      };
    }

    fetch("data.json?cb=" + Date.now())
      .then(r => r.json())
      .then(j => {
        document.getElementById("meta").textContent =
          `${j.meta.location} Â· Zeiten in ${j.meta.timezone}`;
        document.getElementById("dateLabel").textContent =
          new Date().toLocaleDateString("de-DE", { weekday: "long", day: "2-digit", month: "long", year: "numeric" });

        // Tabelle
        const tb = document.getElementById("tbody");
        tb.innerHTML = "";
        (j.tides || []).forEach(e => {
          const badge = e.type === "High"
            ? "<span class='badge high'>Hochwasser</span>"
            : "<span class='badge low'>Niedrigwasser</span>";
          const displayTime = e.timeStr || tLocal(e.iso);
          const h = (e.height ?? 0).toFixed(2);
          tb.innerHTML += `<tr>
            <td>${displayTime}</td>
            <td>${badge}</td>
            <td>${h}</td>
            <td></td>
          </tr>`;
        });

        // Trend unter dem Datum
        const t = computeTrend(j.tides);
        document.getElementById("trend").textContent = t.text;

        // Quelle
        document.getElementById("source").textContent =
          `Quelle: ${j.meta.source} Â· Aktualisiert ${new Date(j.meta.generatedAt).toLocaleString("de-DE",{timeZone:TZ})}`;
      })
      .catch(e => {
        document.getElementById("tbody").innerHTML =
          `<tr><td colspan="4" style="text-align:center;color:#dc2626">Fehler: ${e.message}</td></tr>`;
      });
  </script>
</body>
</html>
