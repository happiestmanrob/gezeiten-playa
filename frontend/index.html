<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gezeiten · Playa del Inglés</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background-color: #eaf6ff; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .btn.active { background: #2563eb; color: white; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="card p-6 max-w-md w-full text-center">
    <h1 class="text-3xl font-bold mb-1">🌊 Gezeiten · Playa del Inglés</h1>
    <p id="date" class="text-gray-600 mb-3"></p>

    <!-- Trend -->
    <div id="arrow" class="text-3xl mb-1"></div>
    <div id="trend" class="font-semibold mb-2"></div>
    <p id="next-tide" class="text-gray-800 mb-4 text-sm"></p>

    <div class="flex justify-center gap-2 mb-4">
      <button id="btn-heute" class="btn px-4 py-2 rounded-lg border">Heute</button>
      <button id="btn-morgen" class="btn px-4 py-2 rounded-lg border">Morgen</button>
      <button id="btn-uebermorgen" class="btn px-4 py-2 rounded-lg border">Übermorgen</button>
    </div>

    <table class="w-full text-sm text-center">
      <thead>
        <tr class="font-semibold">
          <th class="text-center">Zeit</th>
          <th class="text-center">Typ</th>
          <th class="text-center">Höhe (m)</th>
        </tr>
      </thead>
      <tbody id="tides"></tbody>
    </table>

    <p id="source" class="text-xs text-gray-500 mt-4">Quelle: tide-forecast.com · <span id="updated"></span> WET</p>
  </div>

  <script>
    const CANARY_TZ = "Atlantic/Canary";

    function nowCanary() {
      return new Date(new Date().toLocaleString("en-US", { timeZone: CANARY_TZ }));
    }

    function ymdKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const da = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${da}`;
    }

    function findTodayIndex(days) {
      const todayKey = ymdKey(nowCanary());
      return days.findIndex(d => d.date.includes(todayKey));
    }

    function renderDay(day) {
      document.getElementById("date").textContent = day.date;

      const tbody = document.getElementById("tides");
      tbody.innerHTML = "";

      // Tabelle
      day.entries.forEach(e => {
        const tr = document.createElement("tr");
        const color = e.type.toLowerCase().includes("high") ? "text-green-600" : "text-red-600";
        const typeText = e.type.toLowerCase().includes("high") ? "Hochwasser" : "Niedrigwasser";
        tr.innerHTML = `
          <td>${e.time}</td>
          <td class="${color}">${typeText}</td>
          <td>${e.height.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });

      // Trend berechnen
      const now = nowCanary();
      const allTimes = day.entries.map(e => e.time);
      const nextTide = allTimes.find(t => {
        const [h, m] = t.split(":");
        const tideTime = new Date(now);
        tideTime.setHours(h, m, 0, 0);
        return tideTime > now;
      });

      const nextType = nextTide
        ? day.entries.find(e => e.time === nextTide).type
        : day.entries[0].type;

      const isRising = nextType.toLowerCase().includes("high");
      document.getElementById("arrow").textContent = isRising ? "⬆️" : "⬇️";
      document.getElementById("trend").textContent = isRising
        ? "Das Wasser steigt"
        : "Das Wasser fällt";
      document.getElementById("trend").className =
        "font-semibold mb-2 " + (isRising ? "text-green-600" : "text-red-600");

      document.getElementById("next-tide").textContent =
        nextType.toLowerCase().includes("high")
          ? `(nächstes Hochwasser um ${nextTide})`
          : `(nächstes Niedrigwasser um ${nextTide})`;
    }

    function updateButtonsState(offset) {
      const btns = [
        document.getElementById("btn-heute"),
        document.getElementById("btn-morgen"),
        document.getElementById("btn-uebermorgen")
      ];
      btns.forEach(b => b.classList.remove("active"));
      if (btns[offset]) btns[offset].classList.add("active");
    }

    function setViewByOffset(days, offset) {
      const idx = Math.min(Math.max(todayIndex + offset, 0), days.length - 1);
      currentIndex = idx;
      renderDay(days[idx]);
      updateButtonsState(offset);
    }

    let todayIndex = 0;
    let currentIndex = 0;

    fetch("./data/latest.json")
      .then(res => res.json())
      .then(data => {
        const days = data.days || [];
        todayIndex = findTodayIndex(days);
        setViewByOffset(days, 0);
        document.getElementById("btn-heute").addEventListener("click", () => setViewByOffset(days, 0));
        document.getElementById("btn-morgen").addEventListener("click", () => setViewByOffset(days, 1));
        document.getElementById("btn-uebermorgen").addEventListener("click", () => setViewByOffset(days, 2));
        document.getElementById("updated").textContent = "Aktualisiert: " + data.updatedAt;
      })
      .catch(err => {
        console.error(err);
        document.getElementById("tides").innerHTML = `<tr><td colspan="3">Fehler beim Laden der Daten</td></tr>`;
      });
  </script>
</body>
</html>
