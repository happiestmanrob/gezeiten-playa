<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gezeiten ¬∑ Playa del Ingl√©s</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(to bottom right, #dff3ff, #e8f7ff);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 2rem;
    }
    .card {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    h1 {
      font-size: 1.9rem;
      font-weight: 700;
      margin-bottom: 0;
      line-height: 1.2;
    }
    .subtitle {
      font-size: 1.1rem;
      margin-top: 0.3rem;
      color: #333;
    }
    .arrow-line {
      font-size: 2rem;
      margin: 0.3rem 0 0.6rem 0;
    }
    .status {
      margin: 0.4rem 0 1rem 0;
      font-size: 1.2rem;
      font-weight: 500;
    }
    .buttons {
      margin-bottom: 0.8rem;
    }
    button {
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 0.4rem 1rem;
      margin: 0.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #e8e8e8;
    }
    button.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    select {
      margin-top: 0.4rem;
      padding: 0.4rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.6rem;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      color: #444;
      font-weight: 600;
    }
    .hoch {
      color: #007b00;
      font-weight: 600;
    }
    .niedrig {
      color: #cc0000;
      font-weight: 600;
    }
    footer {
      margin-top: 1.2rem;
      font-size: 0.8rem;
      color: #777;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: 1.5rem;
        line-height: 1.1;
      }
      .subtitle {
        font-size: 1rem;
      }
      .arrow-line {
        font-size: 1.8rem;
        margin-top: 0.3rem;
      }
      footer {
        font-size: 0.7rem;
        line-height: 1;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üåä Gezeiten ¬∑ Playa del Ingl√©s</h1>
    <div id="date" class="subtitle"></div>
    <div id="arrow" class="arrow-line"></div>
    <div id="status" class="status"></div>

    <div class="buttons" id="day-buttons"></div>
    <select id="day-select"></select>

    <table>
      <thead>
        <tr>
          <th>Zeit</th>
          <th>Typ</th>
          <th>H√∂he (m)</th>
        </tr>
      </thead>
      <tbody id="tides"></tbody>
    </table>

    <footer id="footer"></footer>
  </div>

  <script>
    const tidesEl = document.getElementById("tides");
    const dateEl = document.getElementById("date");
    const arrowEl = document.getElementById("arrow");
    const statusEl = document.getElementById("status");
    const footerEl = document.getElementById("footer");
    const buttonsContainer = document.getElementById("day-buttons");
    const selectEl = document.getElementById("day-select");

    let data = null;
    let currentIndex = 0;

    async function loadData() {
      try {
        const res = await fetch(`latest.json?nocache=${Date.now()}`);
        data = await res.json();

        if (!data.days || !data.days.length) throw new Error("Keine Gezeiten-Daten gefunden!");

        createButtons();
        createDropdown();
        showDay(0);
      } catch (err) {
        console.error("Fehler beim Laden:", err);
        tidesEl.innerHTML = `<tr><td colspan="3">‚ùå Fehler beim Laden der Daten</td></tr>`;
      }
    }

    function createButtons() {
      buttonsContainer.innerHTML = "";
      const labels = ["Heute", "Morgen", "√úbermorgen"];
      for (let i = 0; i < Math.min(3, data.days.length); i++) {
        const btn = document.createElement("button");
        btn.textContent = labels[i];
        btn.onclick = () => showDay(i);
        if (i === 0) btn.classList.add("active");
        buttonsContainer.appendChild(btn);
      }
    }

    function createDropdown() {
      selectEl.innerHTML = "";
      selectEl.onchange = (e) => showDay(parseInt(e.target.value));
      data.days.forEach((day, i) => {
        const d = new Date(day.date);
        const formatted = d.toLocaleDateString("de-DE");
        const option = document.createElement("option");
        option.value = i;
        option.textContent = formatted;
        selectEl.appendChild(option);
      });
    }

    function showDay(index) {
      currentIndex = index;
      const day = data.days[index];
      const date = new Date(day.date);

      // Datum
      const dateFmt = date.toLocaleDateString("de-DE", {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric"
      });
      dateEl.textContent = dateFmt.charAt(0).toUpperCase() + dateFmt.slice(1);

      // Tabelle (zentriert)
      tidesEl.innerHTML = day.tides.map(t => `
        <tr>
          <td>${t.zeit}</td>
          <td class="${t.typ === "Hochwasser" ? "hoch" : "niedrig"}">${t.typ}</td>
          <td>${t.hoehe_m.toFixed(2)}</td>
        </tr>
      `).join("");

      // Trend & Pfeil
      const now = new Date();
      const [nextTime, nextType] = getNextTide(day.tides, now);
      const trendText = nextType === "Hochwasser" ? "Das Wasser steigt" : "Das Wasser f√§llt";
      const arrow = nextType === "Hochwasser" ? "üåä" : "‚¨áÔ∏è";
      const color = nextType === "Hochwasser" ? "#007b00" : "#cc0000";

      arrowEl.innerHTML = `<span style="color:${color}">${arrow}</span>`;
      statusEl.innerHTML = `<span style="color:${color}">${trendText}<br>(n√§chstes ${nextType} um ${nextTime})</span>`;

      // Footer
      const gen = new Date(data.meta.generatedAt);
      const genFmt = gen.toLocaleString("de-DE", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        timeZone: data.meta.timezone,
      });
      footerEl.textContent = `Quelle: tide-forecast.com ¬∑ Aktualisiert: ${genFmt} WET`;

      // Buttons & Dropdown sync
      [...buttonsContainer.children].forEach((b, i) => b.classList.toggle("active", i === index));
      selectEl.value = index;
    }

    function getNextTide(tides, now) {
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      for (const t of tides) {
        const [h, m] = t.zeit.split(":").map(Number);
        const mins = h * 60 + m;
        if (mins > nowMinutes) return [t.zeit, t.typ];
      }
      return [tides[0].zeit, tides[0].typ];
    }

    loadData();
  </script>
</body>
</html>
