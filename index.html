<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gezeiten ¬∑ Playa del Ingl√©s</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(to bottom right, #dff3ff, #e8f7ff);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 2rem;
    }
    .card {
      background: white;
      border-radius: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    h1 {
      display: inline;
      font-size: 1.9rem;
      font-weight: 700;
    }
    .subtitle {
      font-size: 1.1rem;
      margin-top: 0.3rem;
      color: #333;
    }
    .status {
      margin: 1rem 0;
      font-size: 1.2rem;
      font-weight: 500;
    }
    .buttons {
      margin-bottom: 1rem;
    }
    button {
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 0.4rem 1rem;
      margin: 0 0.2rem;
      cursor: pointer;
    }
    button.active {
      background: #007bff;
      color: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.6rem;
      border-bottom: 1px solid #eee;
    }
    th {
      text-align: left;
      color: #444;
    }
    .hoch {
      color: #007b00;
      font-weight: 600;
    }
    .niedrig {
      color: #cc0000;
      font-weight: 600;
    }
    footer {
      margin-top: 1rem;
      font-size: 0.85rem;
      color: #777;
    }
    @media (max-width: 600px) {
      h1 {
        display: block;
        font-size: 1.4rem;
      }
      .subtitle {
        font-size: 1rem;
      }
      footer {
        font-size: 0.75rem;
        line-height: 1.2;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üåä Gezeiten ¬∑ Playa del Ingl√©s</h1>
    <div id="date" class="subtitle"></div>
    <div id="status" class="status"></div>

    <div class="buttons">
      <button id="btn-today" class="active">Heute</button>
      <button id="btn-tomorrow">Morgen</button>
      <button id="btn-next">√úbermorgen</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Zeit</th>
          <th>Typ</th>
          <th>H√∂he (m)</th>
        </tr>
      </thead>
      <tbody id="tides"></tbody>
    </table>

    <footer id="footer"></footer>
  </div>

  <script>
    const buttons = {
      today: document.getElementById('btn-today'),
      tomorrow: document.getElementById('btn-tomorrow'),
      next: document.getElementById('btn-next'),
    };
    const tidesEl = document.getElementById('tides');
    const dateEl = document.getElementById('date');
    const statusEl = document.getElementById('status');
    const footerEl = document.getElementById('footer');

    let data = null;

    async function loadData() {
      const url = `latest.json?nocache=${Date.now()}`; // Cache umgehen
      const res = await fetch(url);
      data = await res.json();
      updateView(0);
    }

    function updateView(offset) {
      const today = new Date();
      const date = new Date(today);
      date.setDate(today.getDate() + offset);

      const dayISO = date.toISOString().split("T")[0];
      const entry = data.days.find(d => d.date === dayISO);

      if (!entry) {
        tidesEl.innerHTML = `<tr><td colspan="3">Keine Daten f√ºr diesen Tag</td></tr>`;
        return;
      }

      const tides = entry.tides;
      tidesEl.innerHTML = tides.map(t => `
        <tr>
          <td>${t.zeit}</td>
          <td class="${t.typ === "Hochwasser" ? "hoch" : "niedrig"}">${t.typ}</td>
          <td>${t.hoehe_m.toFixed(2)}</td>
        </tr>
      `).join("");

      const dateFmt = date.toLocaleDateString("de-DE", {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric",
      });

      dateEl.textContent = dateFmt.charAt(0).toUpperCase() + dateFmt.slice(1);

      const now = new Date();
      const [next, nextType] = getNextTide(tides, now);
      const trend = nextType === "Hochwasser" ? "Das Wasser steigt üåä" : "Das Wasser f√§llt ‚¨áÔ∏è";
      const color = nextType === "Hochwasser" ? "#007b00" : "#cc0000";
      statusEl.innerHTML = `<span style="color:${color}">${trend}<br>(n√§chstes ${nextType} um ${next})</span>`;

      const gen = new Date(data.meta.generatedAt);
      const genFmt = gen.toLocaleString("de-DE", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        timeZone: "Atlantic/Canary",
      });
      footerEl.textContent = `Quelle: tide-forecast.com ¬∑ Aktualisiert: ${genFmt} WET`;

      Object.values(buttons).forEach(b => b.classList.remove("active"));
      [buttons.today, buttons.tomorrow, buttons.next][offset].classList.add("active");
    }

    function getNextTide(tides, now) {
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      for (const t of tides) {
        const [h, m] = t.zeit.split(":").map(Number);
        const mins = h * 60 + m;
        if (mins > nowMinutes) return [t.zeit, t.typ];
      }
      return [tides[0].zeit, tides[0].typ];
    }

    buttons.today.onclick = () => updateView(0);
    buttons.tomorrow.onclick = () => updateView(1);
    buttons.next.onclick = () => updateView(2);

    loadData();
  </script>
</body>
</html>
